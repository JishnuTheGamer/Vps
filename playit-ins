#!/bin/bash
# Playit installation script - Auto Installer Made by Jishnu
# Tested on Ubuntu/Debian

# Exit on any error, unset variables, or pipe failures
set -euo pipefail

# Colors for better output formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Log file for installation
LOG_FILE="/var/log/playit_install_$(date +%F_%H-%M-%S).log"

# Function to log messages
log_message() {
    echo -e "$1" | tee -a "$LOG_FILE"
}

# Function to handle errors
handle_error() {
    log_message "${RED}Error: $1${NC}"
    exit 1
}

# Check if script is run with sudo
if [[ $EUID -ne 0 ]]; then
    handle_error "This script must be run as root (use sudo)."
fi

# Check if system is Ubuntu/Debian
if ! command -v apt >/dev/null 2>&1; then
    handle_error "This script is designed for Ubuntu/Debian systems only."
fi

log_message "${YELLOW}=== Starting Playit Installation by Jishnu ===${NC}"

# Update system
log_message "${YELLOW}=== Updating system packages ===${NC}"
if ! sudo apt update -y >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to update package lists."
fi
if ! sudo apt upgrade -y >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to upgrade packages."
fi

# Install dependencies
log_message "${YELLOW}=== Installing required dependencies ===${NC}"
if ! sudo apt install -y sudo curl gpg >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to install dependencies."
fi

# Add Playit APT repository
log_message "${YELLOW}=== Adding Playit APT repository ===${NC}"
if ! curl -fsSL https://playit-cloud.github.io/ppa/key.gpg | \
    gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null; then
    handle_error "Failed to add Playit GPG key."
fi

if ! echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | \
    sudo tee /etc/apt/sources.list.d/playit-cloud.list >/dev/null; then
    handle_error "Failed to add Playit repository."
fi

# Update package list again
log_message "${YELLOW}=== Updating package list ===${NC}"
if ! sudo apt update -y >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to update package list after adding repository."
fi

# Install Playit
log_message "${YELLOW}=== Installing Playit ===${NC}"
if ! sudo apt install -y playit >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to install Playit."
fi

# Enable and start Playit service
log_message "${YELLOW}=== Enabling and starting Playit service ===${NC}"
if ! sudo systemctl enable --now playit >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to enable or start Playit service."
fi

# Run Playit setup
log_message "${YELLOW}=== Running Playit setup ===${NC}"
if ! playit setup >> "$LOG_FILE" 2>&1; then
    handle_error "Failed to run Playit setup."
fi

log_message "${GREEN}✅ Playit installation completed successfully!${NC}"
log_message "${GREEN}➡️ Log file: $LOG_FILE${NC}"
log_message "${GREEN}➡️ Run 'playit status' to check the tunnel status.${NC}"
